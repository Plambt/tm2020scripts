/**
 *
 * Stunts for TrackMania 2020
 *
 * written by dassschaf / UD Timmy
 *
 */

// Notice:
// Wheras TM2/Maniaplanet offered a special event that could be handled that would return the jump type rightaway, TM2020 lacks this. Therefore I'm not sure if the gamemode can be written in a manner stunts can be still properly ordered into their types.
// Jump type determination requires figuring out the rotations by the sinus-alike output of Player.Aim.X/Y/Z
// Nadeo please :(

// Extends base mode script of TM 2020:
#Extends "Libs/Nadeo/TMNext/TrackMania/Modes/TMNextBase.Script.txt"

// ---------------------------------- //
// Script Info
#Const	CompatibleMapTypes	"TrackMania\\TM_Race,TM_Race"
#Const  Version     		"0"
#Const  ScriptName  		"Stunts2020.Script.txt"
#Const  C_ModeName          "Stunts2020"
#Const  Description         _("In $<$6f9Stunt mode$>, the goal is to make as much points by tricks in the air as possible before the time is over. Finishing too late and respawning cause point deduction. The winner is the player with the highest score. \n This mode is inspired by the original Stunt mode known from TM 1 or Spaii's stunts titlepack for TM 2.")

// ---------------------------------- //
// Libraries

#Include "MathLib" as MathLib
#Include "TextLib" as TextLib

#Include "Libs/Nadeo/ModeLibs/Legacy/Layers2.Script.txt" as Layers

// ---------------------------------- //
// Settings
// #Setting S_NAME VALUE as _("TEXT")

#Setting S_TimeLimit 300 as _("Time Limit:") ///< as ... for server setup
#Setting S_ShowDebugInfo True as _("Show Debug info")

// ---------------------------------- //
// Constants
// #Const C_NAME VALUE
#Const C_UploadRecord False

// ---------------------------------- //
// Global variables
declare Integer[Text] G_Scores;


// ---------------------------------- //
// Extends

***Match_LogVersion***
***
    // register the script to the log
    Log::RegisterScript(ScriptName, Version);
*** // Match_LogVersion



***Match_Rules***
***
    // register game mode information
    ModeInfo::SetName(C_ModeName);
    ModeInfo::SetType(ModeInfo::C_Type_FreeForAll);
    ModeInfo::SetRules(Description);
    ModeInfo::SetStatusMessage(_("TYPE: Free for all\nOBJECTIVE: Set the best score on the track."));

*** // Match_Rules



***Match_StartServer***
***
    
    // Initialize Gamemode
    Race::SetRespawnBehaviour(Race::C_RespawnBehaviour_NeverGiveUp);
*** // Match_StartServer



***Match_InitMap***
***
    // Map initialization
    G_Scores.clear();
    yield;

*** // Match_InitMap



***Match_StartMap***
***
    // Map actual start


    // Start players for the race
    foreach (Player in Players) {
        Race::Start(Player);
    }

*** // Match_StartMap



***Match_InitTurn***
***
    // Turn initialitzation
    yield;

*** // Match_InitTurn



***Match_StartTurn***
***
    // Turn start
    ModeStatusMessage = "Current map : "^Map.MapInfo.Name;

*** // Match_StartTurn



***Match_PlayLoop***
***
    // actual game mechanics?!

    // ------------------
    // Player phsyics debug info
    foreach (Player in Players) {
        if (Player.SpawnStatus == CSmPlayer::ESpawnStatus::Spawned  && S_ShowDebugInfo) {
            declare Text ManialinkDebugInfo;

            declare Real InputSteer = Player.InputSteer;
            declare Integer FlyingDuration = Player.FlyingDuration;
            declare Real FlyingDistance = Player.FlyingDistance;
            declare Integer WheelsContactCount = Player.WheelsContactCount;
            declare Boolean IsTouchingGround = Player.IsTouchingGround;
            declare Real Upwardness = Player.Upwardness;
            declare Real PosX = Player.Position.X;
            declare Real PosY = Player.Position.Y;
            declare Real PosZ = Player.Position.Z;
            declare Real AimX = Player.AimDirection.X;
            declare Real AimY = Player.AimDirection.Y;
            declare Real AimZ = Player.AimDirection.Z;
            //declare CModeVehicle Vehicle <=> Player.Vehicle;
            //declare Real Pitch = Vehicle.Pitch;
            //declare Real Roll = Vehicle.Roll;

            ManialinkDebugInfo = """
            <label pos="0 1" z-index="0" 
            text="
            Steer: {{{InputSteer}}}
            Fly Duration: {{{FlyingDuration}}}
            Fly Distance: {{{FlyingDistance}}}
            On Ground? {{{IsTouchingGround}}}
            #Wheels: {{{WheelsContactCount}}}
            Upwardness: {{{Upwardness}}}
            Coordinates: X={{{PosX}}}, Y={{{PosY}}}, Z={{{PosZ}}}
            Aim Direction: X={{{AimX}}}, Y={{{AimY}}}, Z={{{AimZ}}}
            "/>
            """;

            // get debug info for the player
            Layers::Create("ManialinkDebugInfo", ManialinkDebugInfo);
            Layers::SetType("ManialinkDebugInfo", CUILayer::EUILayerType::Normal);
            Layers::Attach("ManialinkDebugInfo", Player);
        }
    }

    // ------------------
    // Pending Events Handler
    foreach (Event in PendingEvents) {
        
    }

    // -------------------
    // Manage Player Respawning
    foreach (Player in Players) {
        if (Player.SpawnStatus == CSmPlayer::ESpawnStatus::NotSpawned)
            Race::Start(Player);
    }



***

// this somehow prevents an EOF error?
Void dummy() {
}
